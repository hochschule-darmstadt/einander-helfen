<template>
  <div>
    <Header />

      <v-layout row wrap no-gutters>
        <!-- Map -->
        <v-flex xs12 md6 order-md2 v-if="!postIsOpen">
           <div class="map" v-if="!postIsOpen">
                <v-card tile height="70vh">
                    <div id="map" :style="{height: map.height, width: map.width}">
                        <v-btn @click="closeMap()"
                               style="position: absolute; z-index: 9999; margin-left: 50px; margin-top: 20px;">Details
                        </v-btn>
                        <l-map ref="map" :center="map.center" :zoom="map.zoom">
                            <l-tile-layer :url="map.url" :attribution="map.attribution"></l-tile-layer>
                            <template>
                              <div v-for="(post,i) in posts" :key="i">
                                <l-marker v-if="post.id === currentPostId" :icon="map.markerRed"
                                          :lat-lng="[post.geo_location.lat, post.geo_location.lon]"
                                          @click="openPost(post.id)">
                                    <l-tooltip>{{ post.title }}</l-tooltip>
                                </l-marker>
                                <l-marker v-else :icon="map.markerBlue"
                                          :lat-lng="[post.geo_location.lat, post.geo_location.lon]"
                                          @click="openPost(post.id)">
                                    <l-tooltip>{{ post.title }}</l-tooltip>
                                </l-marker>
                                </div>
                            </template>
                        </l-map>
                    </div>
                </v-card>
            </div>
        </v-flex>

        <!-- right side content-->
        <v-flex sm12 md6 order-md2 v-if="postIsOpen" mb-5>
          <div>
          <v-card
            tile
            style="height:70vh ;overflow:auto"
          >
          <v-list-item three-line>
            <v-btn class="mr-3" text @click="closePost()">
              <v-icon>arrow_back</v-icon>
            </v-btn>

            <!--display title, subtitle and image on the right side-->
            <v-list-item-content style="margin-top:2%" class="headline">{{
                selectedPost.title
              }}
            </v-list-item-content>
            <v-img
              style="margin-top:2%"
              max-width="80px"
              height="80px"
              contain
              :src="selectedPost.image"
            ></v-img>
          </v-list-item>

          <!--display content on the right side-->
          <v-card-text style="padding-left:5%; padding-right:5%">
            <v-row v-if="selectedPost.location">
             <v-flex md4 xs6>Einsatzort</v-flex>
             <v-flex md8 xs6 v-html="selectedPost.location"></v-flex>
            </v-row>
            <v-row class="pt-1" v-if="selectedPost.title">
             <v-flex md4 xs6 >Aufgabe</v-flex>
             <v-flex md8 xs6 v-html="selectedPost.task"></v-flex>
            </v-row>
            <v-row class="pt-1" v-if="selectedPost.contact">
              <v-flex md4 xs6>Ansprechpartner</v-flex>
              <v-flex md8 xs6 v-html="selectedPost.contact"></v-flex>
            </v-row>
            <v-row class="pt-1" v-if="selectedPost.organization">
              <v-flex md4 xs6>Organisation</v-flex>
              <v-flex md8 xs6 v-html="selectedPost.organization"></v-flex>
            </v-row>
            <v-row class="pt-1" v-if="selectedPost.target_group">
              <v-flex md4 xs6>Zielgruppe</v-flex>
              <v-flex md8 xs6 v-html="selectedPost.target_group"></v-flex>
            </v-row>
            <v-row class="pt-1" v-if="selectedPost.timing">
              <v-flex md4 xs6>Einstiegsdatum / Beginn</v-flex>
              <v-flex md8 xs6 v-html="selectedPost.timing"></v-flex>
            </v-row>
            <v-row class="pt-1" v-if="selectedPost.effort">
              <v-flex md4 xs6>Zeitaufwand</v-flex>
              <v-flex md8 xs6 v-html="selectedPost.effort"></v-flex>
            </v-row>
            <v-row class="pt-1" v-if="selectedPost.opportunities">
              <v-flex md4 xs6>MÃ¶glichkeiten</v-flex>
              <v-flex md8 xs6 v-html="selectedPost.opportunities"></v-flex>
            </v-row>
            <v-row class="pt-1" v-if="selectedPost.link">
              <v-flex md4 xs6>Quelle</v-flex>
              <v-flex md8 xs6><a :href="selectedPost.link" target="_blank">{{ selectedPost.source }}</a></v-flex>
            </v-row>
          </v-card-text>

          <v-card-actions>
            <v-flex md12 sm12>
              <v-container style="margin-bottom: 10px">
                <template
                  v-for="(category, i) in selectedPost.categories"
                >
                  <v-chip :key="i" class="mr-2 mt-2">{{ category }}</v-chip>
                </template>
              </v-container>
              <v-spacer></v-spacer>
              <v-container style="display:flex;justify-content:center;">
                <v-btn
                  class="my-2"
                  dark
                  large
                  color="#054C66"
                  :href="selectedPost.link"
                  target="_blank"
                >
                  Zum Angebot
                </v-btn>
              </v-container>
            </v-flex>
          </v-card-actions>
        </v-card>
          </div>
        </v-flex>

        <!--left side content-->
        <v-flex sm12 md6 order-md1 >
          <div style="height:70vh ;overflow:auto">
            <template>
              <v-card class="mb-3" style="background-color:#00254f0c">
                <v-list-item-group v-model="model" class="mb-3"  mandatory="mandatory">
                  <v-list-item class="mb-3" three-line 
                  v-for="(post,i) in visiblePages" @click="openPost(post.id)"
                  :key="i"
                  style="background-color:white">
                  <v-list-item-content>
                    <v-list-item-title class="headline mb-1">{{
                      post.title
                    }}</v-list-item-title>
                    <v-list-item-subtitle>{{
                      post.task
                    }}</v-list-item-subtitle>
                  </v-list-item-content>
                  <v-img
                    max-width="80px"
                    height="80px"
                    contain
                    :src="post.image"
                  ></v-img>
                  </v-list-item>
                </v-list-item-group>
              </v-card>
            </template>
          </div>
        </v-flex>
      </v-layout>
                       <!--pageination-->
          <div class="text-center" style="margin-top:2%; margin-bottom:1%">
            <v-pagination @input="setPage($event)" :value="page" :length="numberOfPages" total-visible="7" color="#054C66"></v-pagination>
          </div>

  </div>


</template>

<!-- test content -->
<script lang="ts">
    import Header from '@/components/layout/Header.vue';
    import Post from '@/models/post';
    import Vue from 'vue';
    import {mapActions, mapState} from 'vuex';

    import L, {LatLngTuple} from 'leaflet';
    import {LMap, LTileLayer, LMarker, LTooltip, LIcon} from 'vue2-leaflet';
    import 'leaflet/dist/leaflet.css';

    export default Vue.extend({
        components: {Header, LMap, LTileLayer, LMarker, LTooltip},
        data(): {
            perPage: number;
            map: any;
        } {
            return {
                perPage: 15,
                map: {
                    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
                    center: [51.5000, 10.5000],
                    zoom: 12,
                    width: '100%',
                    height: '100%',
                    markerBlue: L.icon({
                        iconUrl: require('../../public/images/marker/marker-icon.png'),
                        iconSize: [25, 41]
                    }),
                    markerRed: L.icon({
                        iconUrl: require('../../public/images/marker/marker-icon-red.png'),
                        iconSize: [25, 41]
                    })
                }
            };
        },
        computed: {
            ...mapState(['posts', 'page', 'selectedLocation', 'radiusSearchValue', 'selectedPost']),
            currentPostId(): string {
                return this.selectedPost
                    ? this.selectedPost.id
                    : '';
            },
            postIsOpen(): boolean {
                return !!this.selectedPost;
            },
            visiblePages(): Post[] {
                return this.posts.slice(
                    (this.page - 1) * this.perPage,
                    this.page * this.perPage
                );
            },
            numberOfPages(): number {
                return Math.ceil(this.posts.length / this.perPage);
            }
        },
        created(): void {
            this.hydrateStateFromRoute(this.$route);
        },
        watch: {
            posts(val: Post[], oldVal: Post[]): void {
                if (val.length === 1) {
                    this.openPost(val[0].id);
                }
                if (val.length) {
                  const markers = val.map((post) => [post.geo_location.lat, post.geo_location.lon] as LatLngTuple);
                  (this.$refs.map as LMap).fitBounds(markers);
                }
            },
            radiusSearchValue(): void {
                this.findPosts();
            },
            selectedLocation(): void {
                this.findPosts();
            },
            selectedPost(): void {
                this.updateURIFromState();
            },
            page(value): void {
                this.setPage(value);
            }
        },
        methods: {
            ...mapActions(['hydrateStateFromRoute', 'updateURIFromState', 'setSelectedPost', 'setPage', 'findPosts']),
            openPost(id: string): void {
                        this.setSelectedPost(this.posts.find((post) => post.id === id));
                    },
            closePost(): void {
                const currentPost = this.selectedPost as Post;
                const location = [currentPost.geo_location.lat, currentPost.geo_location.lon] as LatLngTuple;
                this.setSelectedPost(null);
                this.$nextTick(() => {
                    (this.$refs.map as LMap).setCenter(location);
                });
            },
        }
    });
</script>

<style scoped>
    .grid {
        width: 100%;
        display: grid;
        grid-template-columns: 50% 50%;
        grid-template-areas: "posts detail";
    }

    .map,
    .detail {
        grid-area: detail;
        height: 75vh;
    }

    .posts {
        grid-area: posts;
        height: 75vh;
        overflow: auto
    }

    @media (max-width: 500px) {
        .grid {
            grid-template-columns: 100%;
            grid-row-gap: 10px;
            grid-template-areas: "detail" "posts";
        }

        .posts {
            height: auto;
        }
    }
</style>
